<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì„ ë°© ëª©ë¡</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
        }

        .room-list-wrapper {
            width: 90%;
            max-width: 1100px;
            background: rgba(10, 20, 40, 0.9);
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            color: #fff;
        }

        .room-list-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .room-list-header-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-right: auto;
        }

        .room-list-header button,
        .room-list-header input {
            border-radius: 4px;
            border: none;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: #2f7fd6;
            color: #fff;
            cursor: pointer;
        }

        .refresh-btn:hover {
            background: #4d95e5;
        }

        .search-input {
            min-width: 250px;
        }

        .create-btn {
            background: #ff9f3c;
            color: #222;
            font-weight: 600;
            cursor: pointer;
        }

        .create-btn:hover {
            background: #ffb562;
        }

        .room-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .room-table thead {
            background: #2768c5;
        }

        .room-table th,
        .room-table td {
            padding: 8px 10px;
            text-align: left;
        }

        .room-table tbody tr {
            background: rgba(15, 25, 50, 0.95);
            border-top: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
        }

        .room-table tbody tr:hover {
            background: rgba(35, 55, 100, 0.95);
        }

        .enter-btn {
            padding: 4px 10px;
            border-radius: 4px;
            border: none;
            background: #2ecc71;
            color: #fff;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .enter-btn:hover {
            background: #46e485;
        }

        footer {
            width: 100%;
        }
    </style>
</head>

<body>
<header class="navbar">
    <div class="nav-container">
        <h1 class="logo"><a href="index.html">ğŸ­ ê²½ì£¼ ë¬¸í™”ì¬ ë¼ì´ì–´ ê²Œì„</a></h1>
        <nav>
            <ul class="nav-menu">
                <li><a href="heritage_cate.html" class="nav-link">ë¬¸í™”ì¬ ì •ë³´</a></li>
                <li><a href="game_lobby.html" class="nav-link">ê²Œì„ ì‹œì‘</a></li>
                <li><a href="ranking.html" class="nav-link">ë­í‚¹</a></li>
                <li id="login-menu"><a href="login.html" class="nav-link">ë¡œê·¸ì¸</a></li>
                <li id="logout-menu" style="display:none;"><a href="#" class="nav-link" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </nav>
    </div>
</header>

<main>
    <div class="room-list-wrapper">
        <div class="room-list-header">
            <div class="room-list-header-title">ê²Œì„ ë°© ëª©ë¡</div>
            <button class="refresh-btn" id="refresh-btn">â†» ìƒˆë¡œê³ ì¹¨</button>
            <input type="text" class="search-input" id="search-input" placeholder="ë°© ì´ë¦„ ê²€ìƒ‰">
            <button class="create-btn" id="create-btn">+ ë§Œë“¤ê¸°</button>
        </div>

        <table class="room-table">
            <thead>
            <tr>
                <th style="width: 55%;">ë°© ì œëª©</th>
                <th style="width: 15%;">ì¸ì›</th>
                <th style="width: 15%;">ìƒíƒœ</th>
                <th style="width: 15%; text-align:center;">ì…ì¥</th>
            </tr>
            </thead>
            <tbody id="room-table-body"></tbody>
        </table>
    </div>
</main>

<footer>
    <p style="text-align:center; color:#fff; padding:10px 0;">
        &copy; 2025 ê²½ì£¼ ë¬¸í™”ì¬ ê²Œì„ | ì œì‘: ì§€í˜,ì°½ë¯¼,ì„±ë¯¼
    </p>
</footer>

<script src="js/auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // ğŸ”„ Renderì— ë°°í¬ëœ ë°±ì—”ë“œ URL ì‚¬ìš©
    const API_BASE_URL = "https://databaseproject-r39m.onrender.com";

    const tbody = document.getElementById("room-table-body");
    const createBtn = document.getElementById("create-btn");
    const refreshBtn = document.getElementById("refresh-btn");
    const searchInput = document.getElementById("search-input");

    let allRooms = [];

    // -------------------------------
    // ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    // -------------------------------
    async function loadRooms() {
        try {
            const res = await fetch(`${API_BASE_URL}/api/game/rooms`);
            const rooms = await res.json();
            allRooms = rooms;
            renderRooms(rooms);
        } catch (err) {
            console.error("ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            showPopup("ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", {
                title: "ì˜¤ë¥˜",
                type: "error"
            });
        }
    }

    // -------------------------------
    // ë°© ëª©ë¡ í…Œì´ë¸” ë Œë”ë§
    // -------------------------------
    function renderRooms(list) {
        tbody.innerHTML = "";

        list.forEach(room => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${room.roomTitle}</td>
                <td>${room.playerCount}</td>
                <td>${room.isActive ? "ëŒ€ê¸°" : "ì¢…ë£Œ"}</td>
                <td style="text-align:center;">
                    <button class="enter-btn">ì…ì¥</button>
                </td>
            `;

            const enterBtn = tr.querySelector(".enter-btn");
            enterBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                enterRoom(room.roomID);
            });

            tbody.appendChild(tr);
        });
    }

    // -------------------------------
    // ë°© ì…ì¥
    // -------------------------------
    async function enterRoom(roomID) {
        const userStr = localStorage.getItem("user");
        if (!userStr) {
            showPopup("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!", {
                title: "ë¡œê·¸ì¸ í•„ìš”",
                type: "error",
                redirectUrl: "login.html"
            });
            return;
        }
        const user = JSON.parse(userStr);

        try {
            const res = await fetch(`${API_BASE_URL}/api/game/join`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ roomID, userID: user.id }),
            });

            const data = await res.json();
            if (!res.ok) {
                showPopup(data.message || "ì…ì¥ ì‹¤íŒ¨", {
                    title: "ì…ì¥ ì‹¤íŒ¨",
                    type: "error"
                });
                return;
            }

            window.location.href = `game_room.html?roomID=${roomID}`;
        } catch (err) {
            console.error("ë°© ì°¸ê°€ ì‹¤íŒ¨:", err);
            showPopup("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", {
                title: "ì…ì¥ ì˜¤ë¥˜",
                type: "error"
            });
        }
    }

    // -------------------------------
    // ë°© ìƒì„± (ê¸°ë³¸ prompt ë²„ì „, ë‚˜ì¤‘ì— ì»¤ìŠ¤í…€ íŒì—…ìœ¼ë¡œ êµì²´ ê°€ëŠ¥)
    // -------------------------------
    createBtn.addEventListener("click", async () => {
        const userStr = localStorage.getItem("user");
        if (!userStr) {
            showPopup("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!", {
                title: "ë¡œê·¸ì¸ í•„ìš”",
                type: "error",
                redirectUrl: "login.html"
            });
            return;
        }

        const user = JSON.parse(userStr);
        const hostID = user.id;

        const roomTitle = window.prompt("ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (!roomTitle || roomTitle.trim() === "") {
            return; // ì·¨ì†Œ ë˜ëŠ” ë¹ˆ ì…ë ¥
        }

        try {
            const res = await fetch(`${API_BASE_URL}/api/game/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ hostID, roomTitle: roomTitle.trim() })
            });

            const data = await res.json();

            if (!res.ok) {
                showPopup(data.message || "ë°© ìƒì„± ì‹¤íŒ¨", {
                    title: "ë°© ìƒì„± ì‹¤íŒ¨",
                    type: "error"
                });
                return;
            }

            showPopup("ë°©ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!", {
                title: "ì™„ë£Œ",
                type: "success",
                onClose: () => {
                    window.location.href = `game_room.html?roomID=${data.roomID}`;
                }
            });
        } catch (err) {
            console.error("ë°© ìƒì„± ì˜¤ë¥˜:", err);
            showPopup("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!", {
                title: "ì˜¤ë¥˜",
                type: "error"
            });
        }
    });

    // ê²€ìƒ‰ ê¸°ëŠ¥
    searchInput.addEventListener("input", () => {
        const keyword = searchInput.value.toLowerCase();
        renderRooms(allRooms.filter(room =>
            room.roomTitle.toLowerCase().includes(keyword)
        ));
    });

    refreshBtn.addEventListener("click", loadRooms);

    loadRooms();
});
</script>

</body>
</html>
